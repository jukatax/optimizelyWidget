// ==UserScript==
// @name         Optimizely X Widget
// @namespace    https://*/*
// @version      6.8.7
// @encoding     utf-8
// @description  Optimizely X Widget
// @author       Yuliyan Yordanov
// @match        https://domain.here/*
// @include      http://*/*
// @include      https://*/*
// @exclude      /(ourtesco|condeco|github|aha|jira|timex|litmos|payslip|launchandlearn|app\.optimizely|webex|accessmanager|ukirp365|yammer|learningattesco|myaccount\.global)/
// @grant        none
// @updateURL    https://raw.githubusercontent.com/jukatax/optimizelyWidget/master/source_js.min.js
// @downloadURL  https://raw.githubusercontent.com/jukatax/optimizelyWidget/master/source_js.min.js
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==
/*jshint esversion:6*/
/*globals document,window,console,requestAnimationFrame,setTimeout */
/*  @url params to force an experiment
 ?optimizely_x=VARIATIONID&optimizely_token=PUBLIC
 ?optimizely_force_tracking=true
 */
/*
In order for the log to work this script has to be injected before the call to Optimizely, in Tampermonkey set the script to be injected at "document start"
 */
window.location.ancestorOrigins && window.location.ancestorOrigins.length || function (a, b) { "use strict"; function c() { "complete" === document.readyState ? d() : a.requestAnimationFrame(c) } a.optimizely = a.optimizely || [], a.optimizely.push({ type: "log", level: "error" }); let d = () => { b.getElementsByTagName("head")[0] && b.getElementsByTagName("head")[0] && b.getElementsByTagName("body") && b.getElementsByTagName("body")[0] ? (a.optlywidget = { version: "6.8.7", name: "optlyWidget", styles: { bckgrnd_clr: "#f4f7f1", main_clr: "#19405b", active_clr: "#3778ad", font_size: "12px", isTargetPresent: !1, versionWrapper: "position:absolute;top:2px;left:5px;font-size : 0.8em;line-height : 8px;", containerWrapper: "", xwrapper: "padding : 5px 8px; position : absolute; top : 0; right : 0; color : #f00; background : rgba(235,28,36,0.4);cursor : pointer;", results: "font-size : 12px;border : 1px solid #19405b;border-radius : 3px;margin : 10px 0 5px;padding : 5px;", inputField: "margin:0;padding:3px 0;width: auto!important;height: auto!important;display: inline-block;line-height : 14px!important;font-size: 12px!important;", button: "float:none;color : #fff!important;font-size: 12px!important;padding: 3px 10px;width: auto!important; display: inline-block;height: auto;line-height: 14px!important;margin: 0; border : 1px solid #19405b!important;", error: "color : #fff; background : #f00;", hide: "#ccontainer_yuli.hide, #ccontainer_yuli .hide{display : none!important;}", all: "#ccontainer_yuli{position : fixed; z-index : 9999999999; top : 10px;width: auto;min-width: 280px;max-width: 440px; left : 10px; padding : 12px 5px 5px; background : #f4f7f1; box-shadow : 0 0 5px #555; -moz-box-shadow : 0 0 5px #555; -webkit-box-shadow : 0 0 5px #555;color: #19405b;font-family : Helvetica, Arial;font-size: 12px;border-radius: 3px;transition : left 1s ease-in-out;max-height: 100%;overflow-y: scroll;}#ccontainer_yuli div{text-align:left;}#ccontainer_yuli #optlyServerSide div ul{padding:0;margin: 0;}#ccontainer_yuli .positions{ font-size : 0.8em;line-height : 8px;font-style: italic;display: flex; justify-content: space-around; align-items : center;}#ccontainer_yuli .positions span{ display : block; }#ccontainer_yuli .positions span:hover{ cursor:pointer; text-decoration : underline; }#ccontainer_yuli.center{left : calc(50% - 200px);}#ccontainer_yuli.left{left : 10px;}#ccontainer_yuli.right{left  :calc(100% - 440px);}#ccontainer_yuli.hide{display : none!important;}" }, logstyles: "background:orange;color:#000;padding:2px 4px;", clientSideTests: [], serverSideTests: [], targetTests: [], cookieName: "_qa", cookieName2: "ssp" + (b.cookie.match(/sspleft/ig) ? "left" : b.cookie.match(/sspright/ig) ? "right" : b.cookie.match(/sspcenter/ig) ? "center" : "left"), domain: 2 < b.domain.split(".").length ? b.domain.split(".")[b.domain.split(".").length - 2] + "." + b.domain.split(".")[b.domain.split(".").length - 1] : b.domain, count: 0, optlyCounter: 0, targetCounter: 0, sstestsCounter: 0, bertieCounter: 0, countMax: 4, toggleWidget: a => { var c = a; (c.metaKey || c.ctrlKey) && c.shiftKey && 89 === c.keyCode && b.querySelector("#ccontainer_yuli") && b.querySelector("#ccontainer_yuli").classList.toggle("hide") }, log: (...b) => { console.log.call(null, "%c::WIDGET-" + a.optlywidget.name + " v." + a.optlywidget.version + "::", a.optlywidget.logstyles, ...b) }, setCookie: (b, c) => { var e = new Date, d = b, f = document.getElementById("cerror"); if (d) { e.setTime(e.getTime() + 1e3 * (60 * (60 * (24 * c)))); var g = "expires=" + e.toUTCString(); document.cookie = d + "=true;path=/;domain=" + a.optlywidget.domain + ";" + g, f ? f.innerHTML = "Cookie has been Set!" : null, (-1 === c || "-1" === c) && (document.cookie = "optimizelySegments=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelyEndUserId=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelyEndUserId=0;path=/;domain=optimizely.com;expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelyRedirectData=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelyBuckets=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelyEndUserId=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelySegments=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = "optimizelyPendingLogEvents=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;", document.cookie = d + "=0;path=/;domain=" + a.optlywidget.domain + ";expires=Thu, 18 Dec 2013 12:00:00 UTC;") } else ceror ? f.innerHTML = "You need to specify a name for the cookie" : null; d && -1 === d.indexOf("ssp") ? setTimeout(() => { f.innerHTML = "", (-1 == c || a.location.search) && (-1 === c || a.location.search.match(d + "=true")) ? -1 === c && a.location.search && a.location.search.match(d + "=true") ? (a.location.search = a.location.search.replace(d + "=true", ""), a.location.replace(a.location.origin + a.location.pathname)) : -1 == c && a.location.replace(a.location.origin + a.location.pathname) : a.optlywidget.setExperiment("&" + d + "=true") }, 1e3) : setTimeout(() => { f ? f.innerHTML = "" : null }, 1e3) }, setExperiment: b => { var c = a.location.search; a.location.search = !!c && /optimizely_x/.test(c) ? c.replace(/optimizely_x=(\d+)?/, "optimizely_x=" + b) : !!c && /\?/.test(c) ? c + "&optimizely_x=" + b : "optimizely_x=" + b }, createwidget: () => { if (!b.getElementById("optly_tests")) { var c = b.createElement("style"); c.id = "optly_tests", c.textContent = a.optlywidget.styles.all, b.getElementsByTagName("head")[0].appendChild(c) } var d = "<div><div class=\"positions\"><span style=\"" + a.optlywidget.styles.versionWrapper + "\">v: " + a.optlywidget.version + "&nbsp;&nbsp;&nbsp; Ctrl+Shift+Y to toggle</span> <span data-pos=\"left\">left</span> <span data-pos=\"center\">center</span> <span data-pos=\"right\">right</span>   <span id=\"removewidget\" style=\"" + a.optlywidget.styles.xwrapper + "\"> X </span></div><div id=\"optimizely_info_data\" style=\"margin: 2px 24px 0 0;\"><div><input type=\"text\" style=\"" + a.optlywidget.styles.inputField + "\" placeholder=\"cookie name\" id=\"cname_yuli\" value=" + a.optlywidget.cookieName + " /><button id=\"setcookie\" style=\"" + a.optlywidget.styles.button + ";background : " + a.optlywidget.styles.active_clr + "!important;\">Set</button><button id=\"remcookie\" style=\"" + a.optlywidget.styles.button + ";background : #f00!important;\">Remove</button></div><div id=\"cerror\" style=\"" + a.optlywidget.styles.error + "\"></div></div><div id=\"optlyX\"></div><div id=\"optlyServerSide\"></div><div id=\"target\"></div><div id=\"bertie\" class=\"hide\" style=\"" + a.optlywidget.styles.results + "\"></div></div>", e = b.createElement("div"); e.id = "ccontainer_yuli", e.style = a.optlywidget.styles.containerWrapper, e.setAttribute("class", b.cookie.match(/sspleft/ig) ? "left" : b.cookie.match(/sspright/ig) ? "right" : b.cookie.match(/sspcenter/ig) ? "center" : "left"), e.insertAdjacentHTML("afterbegin", d), b.querySelector("#ccontainer_yuli") || b.getElementsByTagName("body")[0].appendChild(e) }, addDOMEvents: () => { b.querySelector("#setcookie").addEventListener("click", () => { a.optlywidget.setCookie(a.optlywidget.cookieName, 60) }, !0), b.querySelector("#remcookie").addEventListener("click", () => { a.optlywidget.setCookie(a.optlywidget.cookieName, -1) }, !0), b.querySelector("#removewidget").addEventListener("click", () => { b.getElementById("ccontainer_yuli").parentNode.removeChild(b.getElementById("ccontainer_yuli")), b.querySelectorAll("#ccontainer_yuli .positions span").forEach(b => { let c = b.getAttribute("data-pos"); b.removeEventListener("click", a.optlywidget.setWidgetPosition.bind(null, c)) }), b.getElementById("optly_tests") && b.getElementById("optly_tests").parentNode.removeChild(b.getElementById("optly_tests")) }, !1), b.onkeydown = a.optlywidget.toggleWidget, b.getElementById("cname_yuli").addEventListener("keyup", b => { a.optlywidget.cookieName = b.target.value }), b.querySelectorAll("#ccontainer_yuli .positions span").forEach(b => { let c = b.getAttribute("data-pos"); b.addEventListener("click", a.optlywidget.setWidgetPosition.bind(null, c), !1) }) }, setWidgetPosition: c => { let d = a.optlywidget.cookieName2.substring(3), e = b.getElementById("ccontainer_yuli"); a.optlywidget.setCookie("ssp" + d, -1), a.optlywidget.cookieName2 = "ssp" + c, e && (e.classList.remove(d), e.classList.add(c)), a.optlywidget.setCookie(a.optlywidget.cookieName2, 30) }, getOptlyServerSideTests: () => { if (b.querySelector("#optlyServerSide")) { var c = b.getElementById("ss_tests") ? b.getElementById("ss_tests") : b.createElement("div"); b.getElementById("ss_tests") ? null : c.style = a.optlywidget.styles.results, b.getElementById("ss_tests") ? null : c.id = "ss_tests"; var d = a.optimizelyData; d ? (a.optlywidget.serverSideTests = [], b.querySelector("#optlyServerSide").innerHTML = "", -1 === a.optlywidget.serverSideTests.indexOf("#### Optly Server-side tests: ####") ? a.optlywidget.serverSideTests.push("#### Optly Server-side tests: ####") : null, a.optlywidget.serverSideTests.push(JSON.stringify(d))) : (a.optlywidget.serverSideTests = [], b.querySelector("#optlyServerSide").innerHTML = "", -1 === a.optlywidget.serverSideTests.indexOf("#### No Optly Server-side experiments running ####") ? widget.serverSideTests.push("#### No Optly Server-side experiments running ####") : null), c.innerHTML = "<ul>" + a.optlywidget.serverSideTests.join("<br />") + "</ul>", b.querySelector("#optlyServerSide").appendChild(c) } else a.optlywidget.getOptlyServerSideTests() }, getOptlyClientSideTests: () => { var c, d = {}, e = [], f = b.body; "function" == typeof Object.assign ? Object.assign(d, a.optimizely.get("state").getVariationMap()) : d = JSON.parse(JSON.stringify(a.optimizely.get("state").getVariationMap())), e = -1 === optimizely.get("state").getActiveExperimentIds().indexOf(void 0) ? e.concat(optimizely.get("state").getActiveExperimentIds()) : e, c = optimizely.get("data"), e.length ? e.forEach(function (e, f) { var g = c.experiments[e], h = d[e].name ? d[e].name : d[e], i = b.createElement("div"); i.innerHTML = "<div id=\"test_id_" + f + "\" style='font-size : " + a.optlywidget.styles.font_size + ";border : 1px solid " + a.optlywidget.styles.main_clr + ";border-radius : 3px;margin : 0 0 5px;padding : 5px;'>ID: " + e + ",rv:<span id=\"test_version\">" + (optimizely.get("data").revision || optimizely.revision) + "</span><br />" + g.name + " </div>", b.querySelector("#test_id_" + f) || (b.querySelector("#optlyX").appendChild(i), g.variations.forEach(function (c) { var d = b.createElement("div"); d.style = "margin : 0;padding : 0 0 0 10px;"; var e = !(h !== c.name), g = "color:" + a.optlywidget.styles.active_clr + ";"; d.innerHTML = e ? "<div style=" + g + "><span id=\"test_name\">" + c.name + " - " + c.id + "<span style='font-style:italic;font-size:'+w.optlywidget.styles.font_size+';'>(active)</span></div>" : "<div><span id=\"test_name\">" + c.name + " - " + c.id + "</span> - <a href='#' style=" + g + " onclick=\"widget.setExperiment(" + c.id + ")\">activate</a></div>", b.querySelector("#test_id_" + f).appendChild(d) })) }) : b.querySelector("#optlyX").innerHTML = "<div style='" + a.optlywidget.styles.results + "'>#### No Optimizely experiments running ####</div>" }, initBertie: () => { if (!(bertie && bertie.on)) a.optlywidget.log("bertie not available...exiting..."); else { let b = document.getElementById("bertie"); a.brty = "", bertie.onAny(function (c) { var d = c["@type"] || c.type || c._eventType; b ? (b.classList.remove("hide"), b.innerHTML = !!!b.textContent.match(d) && ("tesco:UIExperimentRendered" === d || d.match("UIExperiment")) ? b.innerHTML + "<p><b>" + d + "</b> - <b>" + c.experimentName + "</b> - <b>" + c.variationKey + "</b></p>" + a.brty : !!b.textContent.match(d) ? b.innerHTML : b.innerHTML + "<p><b>" + d + "</b></p>" + a.brty, a.brty = "") : a.brty += "<p><b>" + d + "</b></p>", c && d && ("tesco:UIExperimentRendered" === d || d.match("UIExperiment")) && a.optlywidget.getOptlyServerSideTests() }), bertie.on("UIImpression", function () { }) } }, poll4optlyX: () => { if (!!!!(b.getElementsByTagName("body")[0] && a.optimizely && "function" == typeof a.optimizely.get && a.optimizely.get("state").getVariationMap())) a.optlywidget.getOptlyClientSideTests(); else if (a.optlywidget.optlyCounter < a.optlywidget.countMax) a.optlywidget.optlyCounter += .5, setTimeout(a.optlywidget.poll4optlyX, 250); else return void (b.querySelector("#optlyX").innerHTML = "<div style='" + a.optlywidget.styles.results + "'>#### No Optimizely tag present ####</div>") }, poll4OptlyServerSide: () => { if ("object" == typeof window.optimizelyData) a.optlywidget.getOptlyServerSideTests(); else if (a.optlywidget.sstestsCounter < a.optlywidget.countMax) a.optlywidget.sstestsCounter += .5, setTimeout(a.optlywidget.poll4OptlyServerSide, 250); else return void (b.querySelector("#optlyServerSide").innerHTML = "<div style='" + a.optlywidget.styles.results + "'>#### No Optly server-side experiments ####</div>") }, poll4Bertie: () => { if (!!(a.bertie && a.bertie.on)) a.optlywidget.initBertie(); else if (a.optlywidget.bertieCounter < a.optlywidget.countMax) a.optlywidget.bertieCounter += .5, setTimeout(a.optlywidget.poll4Bertie, 500); else return }, init: () => { a.optlywidget.createwidget(), a.optlywidget.addDOMEvents(), a.optlywidget.poll4optlyX(), a.optlywidget.poll4OptlyServerSide(), a.optlywidget.poll4Bertie() } }, a.optlywidget.init()) : a.requestAnimationFrame(d) }; c(), b.addEventListener("DOMContentLoaded", function b() { "complete" === document.readyState ? d() : a.requestAnimationFrame(b) }), function (...a) { console.log.call(null, "%c::WIDGET-Optimizely X Widget v.6.8.7::", "background:orange;color:#000;padding:2px 4px;", ...a) }("running...") }(window, document);